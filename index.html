<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Orbe TEC con Voz Profesional</title>
    <style>
        /* (Mant√©n todos los estilos anteriores exactamente igual) */
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .app-container {
            display: flex;
            max-width: 1200px;
            width: 100%;
            gap: 30px;
            flex-wrap: wrap;
        }
        .orb-section {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .orb-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin-bottom: 30px;
        }
        .orb {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            transition: all 0.5s ease;
        }
        .orb::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                var(--orb-color-1) 0%,
                var(--orb-color-2) 25%,
                var(--orb-color-3) 50%,
                var(--orb-color-4) 75%,
                var(--orb-color-1) 100%
            );
            filter: blur(20px);
            opacity: 0.7;
            animation: rotateOrb 20s linear infinite;
        }
        .orb-inner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 160px;
            height: 160px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .orb-letter {
            font-size: 60px;
            font-weight: 900;
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            font-family: 'Arial', sans-serif;
        }
        .orb-pulse {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        /* Estados del orbe (igual) */
        .orb-state-idle {
            --orb-color-1: #4DA3FF;
            --orb-color-2: #2a5298;
            --orb-color-3: #1e3c72;
            --orb-color-4: #4DA3FF;
        }
        .orb-state-listening {
            --orb-color-1: #00ff88;
            --orb-color-2: #00cc6a;
            --orb-color-3: #00994c;
            --orb-color-4: #00ff88;
            animation: listeningPulse 1.5s ease-in-out infinite !important;
        }
        .orb-state-thinking {
            --orb-color-1: #9966ff;
            --orb-color-2: #7b52cc;
            --orb-color-3: #5d3f99;
            --orb-color-4: #9966ff;
            animation: thinkingSpin 3s linear infinite !important;
        }
        .orb-state-speaking {
            --orb-color-1: #ffcc00;
            --orb-color-2: #ff9900;
            --orb-color-3: #ff6600;
            --orb-color-4: #ffcc00;
            animation: speakingWave 1.2s ease-in-out infinite !important;
        }
        .orb-state-confused {
            --orb-color-1: #ff4444;
            --orb-color-2: #cc3636;
            --orb-color-3: #992828;
            --orb-color-4: #ff4444;
            animation: confusedShake 0.5s ease-in-out infinite !important;
        }
        .orb-state-error {
            --orb-color-1: #ff3366;
            --orb-color-2: #cc2952;
            --orb-color-3: #991f3d;
            --orb-color-4: #ff3366;
            animation: errorFlash 1s ease-in-out infinite !important;
        }
        @keyframes rotateOrb { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.1); opacity: 0; } }
        @keyframes listeningPulse { 0%,100% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.05); opacity: 1; } }
        @keyframes thinkingSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes speakingWave { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }
        @keyframes confusedShake { 0%,100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        @keyframes errorFlash { 0%,100% { opacity: 0.5; } 50% { opacity: 1; } }

        .orb-controls { margin-top: 20px; text-align: center; }
        .orb-status { font-size: 16px; color: #aaa; margin-bottom: 15px; min-height: 24px; }
        .listen-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }
        .listen-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,255,136,0.4); }
        .listen-btn:disabled { background: #666; cursor: not-allowed; transform: none; box-shadow: none; }
        .timer-display { margin-top: 15px; font-size: 14px; color: #4DA3FF; }

        /* Secci√≥n chat (igual) */
        .chat-section { flex: 1; min-width: 400px; display: flex; flex-direction: column; }
        #chatContainer {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            min-height: 600px;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .chat-title h1 {
            margin: 0;
            background: linear-gradient(135deg, #4DA3FF, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 28px;
        }
        .chat-title p { margin: 5px 0 0; color: #aaa; font-size: 14px; }
        #refreshChat {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 10px;
            transition: 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #refreshChat:hover { background: rgba(255,255,255,0.2); }
        #chat {
            flex: 1;
            overflow-y: auto;
            padding-right: 15px;
            margin-bottom: 20px;
            max-height: 400px;
        }
        .msg {
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 15px;
            max-width: 85%;
            line-height: 1.5;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
            position: relative;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .user {
            background: linear-gradient(135deg, rgba(77,163,255,0.2), rgba(0,255,136,0.1));
            margin-left: auto;
            border-bottom-right-radius: 5px;
            border-left: 3px solid #4DA3FF;
        }
        .bot {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-bottom-left-radius: 5px;
            border-right: 3px solid #00ff88;
        }
        .msg-time { font-size: 11px; color: #888; margin-top: 5px; text-align: right; }
        #inputBox {
            display: flex;
            gap: 12px;
            margin-top: auto;
            position: relative;
        }
        #messageInput {
            flex: 1;
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            outline: none;
            background: rgba(255,255,255,0.08);
            color: white;
            font-size: 15px;
            transition: all 0.3s;
        }
        #messageInput:focus { border-color: #00ff88; box-shadow: 0 0 0 3px rgba(0,255,136,0.1); }
        #sendBtn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #4DA3FF, #00ff88);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 600;
            min-width: 100px;
        }
        #sendBtn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(77,163,255,0.4); }
        #loader { display: none; margin-bottom: 20px; }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: typing 1.4s infinite both;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%,60%,100% { transform: translateY(0); opacity: 0.3; }
            30% { transform: translateY(-5px); opacity: 1; }
        }
        .timeout-warning {
            background: rgba(255,68,68,0.1);
            border: 1px solid rgba(255,68,68,0.3);
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeIn 0.3s ease;
        }
        .timeout-warning span { color: #ff4444; font-size: 14px; }
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .orb-section, .chat-section { min-width: 100%; }
            .orb-container { width: 200px; height: 200px; }
            .orb-inner { width: 120px; height: 120px; }
            .orb-letter { font-size: 40px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- SECCI√ìN ORBE -->
    <div class="orb-section">
        <div class="orb-container">
            <div class="orb orb-state-idle" id="orb">
                <div class="orb-inner">
                    <div class="orb-letter">T</div>
                </div>
                <div class="orb-pulse"></div>
            </div>
        </div>
        
        <div class="orb-controls">
            <div class="orb-status" id="orbStatus">En espera</div>
            <button class="listen-btn" id="listenBtn">
                <span>üé§</span> Escuchar de nuevo
            </button>
            <div class="timer-display" id="timerDisplay"></div>
        </div>
    </div>

    <!-- SECCI√ìN CHAT -->
    <div class="chat-section">
        <div id="chatContainer">
            <div class="chat-header">
                <div class="chat-title">
                    <h1>Orbe TEC</h1>
                    <p>Asistente virtual con voz profesional</p>
                </div>
                <button id="refreshChat"><span>‚Üª</span> Reiniciar Chat</button>
            </div>

            <div id="chat"></div>
            
            <div id="loader">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <span>Procesando tu mensaje...</span>
                </div>
            </div>
            
            <div id="inputBox">
                <input id="messageInput" type="text" placeholder="Escribe tu mensaje o haz clic en 'Escuchar de nuevo'..." />
                <button id="sendBtn">Enviar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==================== CONFIGURACI√ìN ====================
const N8N_WEBHOOK_URL = "https://n8n.srv1161635.hstgr.cloud/webhook/6b4f38ff-0de0-49f0-843f-a277a55bdfd5";
const GOOGLE_TTS_API_KEY = "AIzaSyBw9gcm5AKRGOi0iGbHgCS6CbUuwfjr4VI"; // REEMPLAZA CON TU CLAVE

let sessionId = localStorage.getItem("sessionId") || crypto.randomUUID();
localStorage.setItem("sessionId", sessionId);

// ==================== ESTADOS DEL ORBE ====================
const ORB_STATES = {
    IDLE: 'idle',
    LISTENING: 'listening',
    THINKING: 'thinking',
    SPEAKING: 'speaking',
    CONFUSED: 'confused',
    ERROR: 'error'
};

let currentOrbState = ORB_STATES.IDLE;
let listenTimeout = null;
let listenTimer = null;
let listenTimeLeft = 30;
let isListening = false;

// Elementos DOM
const orb = document.getElementById('orb');
const orbStatus = document.getElementById('orbStatus');
const listenBtn = document.getElementById('listenBtn');
const timerDisplay = document.getElementById('timerDisplay');

// ==================== RECONOCIMIENTO DE VOZ (Web Speech API) ====================
let recognition = null;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'es-ES';
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
        isListening = true;
        updateOrbState(ORB_STATES.LISTENING, 'Escuchando... Habla ahora');
        listenBtn.disabled = true;
        listenBtn.innerHTML = '<span>‚è∏Ô∏è</span> Escuchando...';
        startListenTimer();
    };

    recognition.onresult = (event) => {
        const lastResult = event.results[event.results.length - 1];
        const transcript = lastResult[0].transcript;
        
        if (lastResult.isFinal) {
            console.log('Texto reconocido (final):', transcript);
            stopListening();
            // Enviar el texto al chat autom√°ticamente
            document.getElementById('messageInput').value = transcript;
            sendMessage();
        } else {
            // Mostrar texto provisional (opcional)
            orbStatus.textContent = `Escuchando: "${transcript}"`;
        }
    };

    recognition.onerror = (event) => {
        console.error('Error de reconocimiento:', event.error);
        stopListening();
        let message = '';
        switch(event.error) {
            case 'not-allowed': message = 'Permiso de micr√≥fono denegado'; break;
            case 'no-speech': message = 'No se detect√≥ voz'; break;
            case 'network': message = 'Error de red'; break;
            default: message = 'Error al escuchar';
        }
        updateOrbState(ORB_STATES.CONFUSED, message);
        setTimeout(() => updateOrbState(ORB_STATES.IDLE), 3000);
    };

    recognition.onend = () => {
        if (isListening) stopListening();
    };
} else {
    console.warn('Reconocimiento de voz no soportado');
    listenBtn.disabled = true;
    listenBtn.title = 'Tu navegador no soporta reconocimiento de voz';
}

// Funciones de control de escucha
function startListening() {
    if (!recognition) {
        alert('Reconocimiento de voz no disponible en este navegador');
        return;
    }
    if (isListening) return;
    try {
        recognition.start();
    } catch (error) {
        console.error('Error al iniciar reconocimiento:', error);
    }
}

function stopListening() {
    if (!isListening) return;
    isListening = false;
    if (recognition) recognition.stop();
    clearInterval(listenTimer);
    clearTimeout(listenTimeout);
    listenBtn.disabled = false;
    listenBtn.innerHTML = '<span>üé§</span> Escuchar de nuevo';
    timerDisplay.textContent = '';
}

function startListenTimer() {
    listenTimeLeft = 30;
    updateTimerDisplay();
    listenTimer = setInterval(() => {
        listenTimeLeft--;
        updateTimerDisplay();
        if (listenTimeLeft <= 0) {
            stopListening();
            showTimeoutWarning();
        }
    }, 1000);
    listenTimeout = setTimeout(() => {
        stopListening();
        showTimeoutWarning();
    }, 30000);
}

function updateTimerDisplay() {
    if (isListening) {
        timerDisplay.textContent = `Tiempo restante: ${listenTimeLeft}s`;
        timerDisplay.style.color = listenTimeLeft <= 10 ? '#ff4444' : listenTimeLeft <= 20 ? '#ffcc00' : '#4DA3FF';
    } else {
        timerDisplay.textContent = '';
    }
}

function showTimeoutWarning() {
    updateOrbState(ORB_STATES.CONFUSED, 'Tiempo agotado. ¬øQuieres intentar de nuevo?');
    const warning = document.createElement('div');
    warning.className = 'timeout-warning';
    warning.innerHTML = `<span>‚ö†Ô∏è</span><span>El tiempo de escucha ha terminado. Haz clic en "Escuchar de nuevo" o escribe tu mensaje.</span>`;
    document.getElementById('chat').appendChild(warning);
    setTimeout(() => warning.remove(), 5000);
}

// ==================== S√çNTESIS DE VOZ CON GOOGLE CLOUD TTS ====================
async function speakText(text) {
    if (!text.trim()) return;

    // Limpiar texto de HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = text;
    const cleanText = tempDiv.textContent || tempDiv.innerText || "";

    updateOrbState(ORB_STATES.SPEAKING, 'Generando audio...');

    try {
        // Configuraci√≥n de la solicitud a Google TTS
        const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                input: { text: cleanText },
                voice: {
                    languageCode: 'es-ES',
                    name: 'es-US-Standard-A', // Voz femenina est√°ndar (cambiable)
                    ssmlGender: 'FEMALE'
                },
                audioConfig: { audioEncoding: 'MP3' }
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Error TTS: ${errorData.error?.message || response.status}`);
        }

        const data = await response.json();
        // El audio viene en base64
        const audioContent = data.audioContent;
        
        // Reproducir el audio
        const audio = new Audio(`data:audio/mp3;base64,${audioContent}`);
        
        audio.onplay = () => updateOrbState(ORB_STATES.SPEAKING, 'Hablando...');
        audio.onended = () => {
            updateOrbState(ORB_STATES.IDLE);
            currentAudio = null;
        };
        audio.onerror = (e) => {
            console.error('Error al reproducir audio:', e);
            updateOrbState(ORB_STATES.ERROR, 'Error al reproducir');
            setTimeout(() => updateOrbState(ORB_STATES.IDLE), 2000);
        };

        currentAudio = audio; // Para poder detenerlo si es necesario
        audio.play();

    } catch (error) {
        console.error('Error en s√≠ntesis de voz:', error);
        updateOrbState(ORB_STATES.ERROR, 'Error en voz');
        // Fallback: usar Web Speech API si falla la externa
        fallbackSpeak(cleanText);
    }
}

// Funci√≥n de respaldo por si falla la API externa
function fallbackSpeak(text) {
    if (!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'es-ES';
    utterance.onstart = () => updateOrbState(ORB_STATES.SPEAKING, 'Hablando (voz local)...');
    utterance.onend = () => updateOrbState(ORB_STATES.IDLE);
    window.speechSynthesis.speak(utterance);
}

// ==================== FUNCIONES DEL ORBE ====================
function updateOrbState(state, message = '') {
    currentOrbState = state;
    orb.className = 'orb';
    orb.classList.add(`orb-state-${state}`);
    
    const statusMessages = {
        idle: 'En espera',
        listening: 'Escuchando...',
        thinking: 'Pensando...',
        speaking: 'Hablando...',
        confused: 'No entend√≠ eso',
        error: 'Error de conexi√≥n'
    };
    orbStatus.textContent = message || statusMessages[state];
    console.log(`Orbe: ${state}`);
}

// ==================== FUNCIONES DEL CHAT ====================
function showInitialMessage() {
    setTimeout(() => {
        agregarMensajeBot(`
            <b>¬°Hola! üëã Soy tu Orbe TEC.</b><br>
            Estoy aqui para ayudarte con cualquier cosa que necesites.<br><br>
            Puedes escribirme o hacer clic en "Escuchar de nuevo" para hablarme.<br><br>
            ¬øEn qu√© puedo ayudarte hoy?
        `);
        // Opcional: hablar el mensaje inicial con la nueva voz
        // speakText("¬°Hola! Soy tu Orbe TEC. ¬øEn qu√© puedo ayudarte hoy?");
    }, 500);
}

async function sendMessage() {
    const input = document.getElementById("messageInput");
    const message = input.value.trim();
    if (!message) return;

    agregarMensajeUsuario(message);
    input.value = "";
    input.focus();

    mostrarProcesando(true);
    updateOrbState(ORB_STATES.THINKING, 'Procesando...');

    try {
        const response = await fetch(N8N_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message, sessionId })
        });

        if (!response.ok) throw new Error(`Error ${response.status}`);

        const data = await response.json();
        const respuesta = data.output || data.message || "Sin respuesta";

        mostrarProcesando(false);
        agregarMensajeBot(respuesta);
        
        // Hablar la respuesta con la API externa
        speakText(respuesta);

    } catch (error) {
        console.error("Error:", error);
        mostrarProcesando(false);
        updateOrbState(ORB_STATES.ERROR, 'Error de conexi√≥n');
        agregarMensajeBot(`‚ö†Ô∏è Error al conectar con el servidor<br><small>${error.message}</small>`);
        setTimeout(() => updateOrbState(ORB_STATES.IDLE), 3000);
    }
}

function agregarMensajeUsuario(msg) {
    const chat = document.getElementById("chat");
    const burbuja = document.createElement("div");
    burbuja.className = "msg user";
    burbuja.innerHTML = msg;
    const time = document.createElement("div");
    time.className = "msg-time";
    time.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    burbuja.appendChild(time);
    chat.appendChild(burbuja);
    chat.scrollTop = chat.scrollHeight;
}

function agregarMensajeBot(msgHTML) {
    const chat = document.getElementById("chat");
    const burbuja = document.createElement("div");
    burbuja.className = "msg bot";
    burbuja.innerHTML = msgHTML;
    const time = document.createElement("div");
    time.className = "msg-time";
    time.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    burbuja.appendChild(time);
    chat.appendChild(burbuja);
    chat.scrollTop = chat.scrollHeight;
}

function mostrarProcesando(show) {
    document.getElementById("loader").style.display = show ? "block" : "none";
}

function refrescarChat() {
    document.getElementById("chat").innerHTML = "";
    sessionId = crypto.randomUUID();
    localStorage.setItem("sessionId", sessionId);
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }
    stopListening();
    updateOrbState(ORB_STATES.IDLE, 'Chat reiniciado');
    agregarMensajeBot(`<b>¬°Chat reiniciado! üîÑ</b><br>¬øEn qu√© puedo ayudarte ahora?`);
}

// ==================== EVENT LISTENERS ====================
document.addEventListener('DOMContentLoaded', function() {
    showInitialMessage();
    
    document.getElementById("sendBtn").addEventListener("click", sendMessage);
    document.getElementById("messageInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });
    document.getElementById("refreshChat").addEventListener("click", refrescarChat);
    listenBtn.addEventListener("click", startListening);
    
    // Detener escucha si el usuario empieza a escribir
    document.getElementById("messageInput").addEventListener("input", () => {
        if (isListening) stopListening();
    });
});

// Limpiar recursos al cerrar
window.addEventListener('beforeunload', () => {
    if (isListening && recognition) recognition.stop();
    if (currentAudio) currentAudio.pause();
});
</script>
</body>
</html>
