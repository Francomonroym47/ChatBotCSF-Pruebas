<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Funcional</title>
</head>
<body>
    <div id="chatContainer">
        <div id="chat"></div>
        <div>
            <input id="messageInput" type="text" placeholder="Escribe tu mensaje...">
            <button id="sendBtn">Enviar</button>
            <button id="refreshChat">Reiniciar</button>
        </div>
    </div>

    <script>
    const N8N_WEBHOOK_URL = "https://n8n.srv1161635.hstgr.cloud/webhook/6b4f38ff-0de0-49f0-843f-a277a55bdfd5";
    let sessionId = localStorage.getItem("sessionId") || crypto.randomUUID();
    localStorage.setItem("sessionId", sessionId);

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        agregarMensajeBot("¡Hola! Soy tu asistente. ¿En qué puedo ayudarte?");
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById("sendBtn").addEventListener("click", sendMessage);
        document.getElementById("messageInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") sendMessage();
        });
        document.getElementById("refreshChat").addEventListener("click", refrescarChat);
    }

    async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        agregarMensajeUsuario(message);
        input.value = "";

        try {
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: message, sessionId: sessionId })
            });

            if (!response.ok) throw new Error(`Error: ${response.status}`);

            const data = await response.json();
            const respuesta = data.output || data.message || "Sin respuesta";
            agregarMensajeBot(respuesta);

        } catch (error) {
            agregarMensajeBot(`Error: ${error.message}`);
        }
    }

    function agregarMensajeUsuario(msg) {
        const chat = document.getElementById("chat");
        const div = document.createElement("div");
        div.textContent = "Tú: " + msg;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function agregarMensajeBot(msgHTML) {
        const chat = document.getElementById("chat");
        const div = document.createElement("div");
        div.innerHTML = "Asistente: " + msgHTML;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function refrescarChat() {
        document.getElementById("chat").innerHTML = "";
        sessionId = crypto.randomUUID();
        localStorage.setItem("sessionId", sessionId);
        agregarMensajeBot("Chat reiniciado. ¿En qué puedo ayudarte?");
    }
    </script>
</body>
</html>
